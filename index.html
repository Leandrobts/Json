<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PoC Isolado v2.3i - Teste de Sanidade JS</title>
    <style>
        body { background: #111; color: #eee; font-family: monospace; padding: 15px; font-size: 14px; }
        #output { background: #222; border: 1px solid #444; padding: 10px; height: 80vh; overflow-y: auto; white-space: pre-wrap; margin-top: 10px; }
        .log-info { color: #6cf; } .log-test { color: #fff; font-weight: bold; }
        /* Adicione outras classes de log se precisar testá-las especificamente */
    </style>
</head>
<body>
    <h1>PoC Isolado v2.3i - Teste de Sanidade JS e Log</h1>
    <p>Este teste verifica se o JavaScript básico e o logging estão funcionando.</p>
    <button id="runBtn" onclick="runIsolatedTest()">Iniciar Teste de Sanidade</button>
    <div id="output"></div>

    <script>
        const outputDivElement = document.getElementById('output'); // Pega uma vez no escopo global
        const runBtnElement = document.getElementById('runBtn'); // Pega uma vez

        // Função de log SIMPLIFICADA para este teste
        function logToMyDiv(message, type = 'info') {
            console.log(`[CONSOLE LOGS1 ${type.toUpperCase()}] ${message}`); // Sempre loga no console
            if (!outputDivElement) {
                console.error("Elemento 'outputDivElement' é NULO em logToMyDiv!");
                return;
            }
            try {
                const timestamp = `[${new Date().toLocaleTimeString()}]`;
                const sanitizedMessage = String(message).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                // Para simplificar, apenas um tipo de log na div por enquanto
                outputDivElement.innerHTML += `<span class="log-${type}">${timestamp} ${sanitizedMessage}\n</span>`;
                outputDivElement.scrollTop = outputDivElement.scrollHeight;
            } catch (e) {
                console.error("ERRO DENTRO DE logToMyDiv:", e);
                // Tenta um log de emergência se a manipulação do DOM falhar
                outputDivElement.innerHTML += "ERRO NO LOG!\n";
            }
        }

        function testCoreFunctionality() {
            logToMyDiv("PASSO 1: testCoreFunctionality FOI CHAMADA.", 'test');

            try {
                logToMyDiv("PASSO 2: Tentando poluir Object.prototype.testProp (simples).", 'info');
                Object.prototype.testProp = "Poluído com Sucesso!";
                logToMyDiv("PASSO 3: Object.prototype.testProp poluído.", 'good');

                let obj = {};
                if (obj.testProp === "Poluído com Sucesso!") {
                    logToMyDiv("PASSO 4: Poluição verificada em novo objeto.", 'good');
                } else {
                    logToMyDiv("PASSO 4: FALHA ao verificar poluição em novo objeto.", 'error');
                }

                delete Object.prototype.testProp; // Limpeza
                logToMyDiv("PASSO 5: Object.prototype.testProp restaurado/deletado.", 'info');

                logToMyDiv("PASSO 6: Tentando JSON.stringify em objeto simples.", 'info');
                const simpleObj = { keyA: "valA", keyB: 123 };
                const jsonResult = JSON.stringify(simpleObj);
                logToMyDiv(`PASSO 7: Resultado de JSON.stringify: ${jsonResult}`, 'info');
                if (jsonResult === '{"keyA":"valA","keyB":123}') {
                    logToMyDiv("PASSO 8: JSON.stringify de objeto simples FUNCIONOU como esperado.", 'good');
                } else {
                    logToMyDiv("PASSO 8: JSON.stringify de objeto simples NÃO funcionou como esperado.", 'error');
                }

            } catch (e) {
                logToMyDiv(`ERRO em testCoreFunctionality: ${e.message}`, 'error');
                if(e.stack) logToMyDiv(`Stack do erro: ${e.stack}`, 'error');
                console.error("ERRO EM testCoreFunctionality:", e);
            }
            logToMyDiv("PASSO 9: testCoreFunctionality CONCLUÍDA.", 'test');
        }

        // Função principal chamada pelo botão
        async function runIsolatedTest() {
            if (!runBtnElement) { // Verifica se o botão foi encontrado
                console.error("Elemento 'runBtnElement' é NULO em runIsolatedTest!");
                alert("Erro: Botão de teste não encontrado!"); // Feedback visual imediato
                return;
            }
            runBtnElement.disabled = true;

            // Limpa o output div primeiro e loga no console e na div
            if (outputDivElement) {
                outputDivElement.innerHTML = '';
            } else {
                console.error("Elemento 'outputDivElement' é NULO no início de runIsolatedTest!");
                alert("Erro: Div de output não encontrada!"); // Feedback visual imediato
                runBtnElement.disabled = false;
                return;
            }
            
            console.log("runIsolatedTest (v2.3i) FOI CHAMADA! (Console log)");
            logToMyDiv("==== INICIANDO PoC Isolado v2.3i (Teste de Sanidade JS) ====", 'test');
            
            try {
                logToMyDiv("Antes de chamar testCoreFunctionality.", 'info');
                testCoreFunctionality(); // Chamada síncrona para este teste
                logToMyDiv("Depois de chamar testCoreFunctionality.", 'info');
            } catch (e) {
                logToMyDiv(`ERRO ao chamar ou dentro de testCoreFunctionality: ${e.message}`, 'error');
                console.error("ERRO em runIsolatedTest ao executar testCoreFunctionality:", e);
            }
            
            // PAUSE_S1_FUNC não é definido neste script simplificado, se precisar, adicione-o:
            // const PAUSE_S1_FUNC = (ms = 50) => new Promise(r => setTimeout(r, ms));
            // await PAUSE_S1_FUNC(200); 

            logToMyDiv("\n==== PoC Isolado v2.3i CONCLUÍDO ====", 'test');
            runBtnElement.disabled = false;
        }
    </script>
</body>
</html>
