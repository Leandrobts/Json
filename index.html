<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PoC Isolado v2.3h - Testando Poluição vs Stringify</title>
    <style> /* ... (estilos como antes) ... */ </style>
</head>
<body>
    <h1>PoC Isolado v2.3h - Testando Poluição vs Stringify</h1>
    <button id="runBtn" onclick="runIsolatedTest()">Iniciar Teste Isolado v2.3h</button>
    <div id="output"></div>

    <script>
        // AdvancedInt64 e generalUtils como antes...
        class AdvancedInt64 { /* ... (código completo como antes) ... */ }
        const generalUtils = { /* ... (código completo como antes) ... */ };

        const outputDivS1 = document.getElementById('output');
        const runBtn = document.getElementById('runBtn');
        const MEDIUM_PAUSE_S1 = 200;

        const logS1 = (message, type = 'info', funcName = '') => {
            console.log(`[CONSOLE LOGS1 ${type.toUpperCase()}] ${funcName ? '['+funcName+'] ' : ''}${message}`);
            generalUtils.logToDiv('output', message, type, funcName);
        };
        const PAUSE_S1_FUNC = (ms = 50) => new Promise(r => setTimeout(r, ms));
        
        const testObject_h = { simple_key_h: "simple_value_h" };
        let callCount_toJSON_h = 0;

        const testPPJsonHijack_v23h = async () => {
            const FNAME = 'testPPJsonHijack_v23h';
            logS1("DEPURANDO: Entrou em testPPJsonHijack_v23h", 'critical', FNAME);
            
            const ppKey = 'toJSON'; 
            let originalToJSON_Descriptor_h;
            let ppAppliedSuccessfully_h = false;
            callCount_toJSON_h = 0;

            try {
                logS1("DEPURANDO: testPPJsonHijack_v23h - Antes de getOwnPropertyDescriptor", 'critical', FNAME);
                originalToJSON_Descriptor_h = Object.getOwnPropertyDescriptor(Object.prototype, ppKey);
                logS1("DEPURANDO: testPPJsonHijack_v23h - Depois de getOwnPropertyDescriptor", 'critical', FNAME);

                // --- PASSO 1: Testar apenas a poluição do protótipo ---
                Object.prototype[ppKey] = function() { // Descomentado
                    callCount_toJSON_h++;
                    let logPrefix = `toJSON PoC v2.3h (Chamada ${callCount_toJSON_h})`;
                    console.log(`${logPrefix} - toJSON POLUÍDO INVOCADO! (v2.3h)`); 
                    logS1(`${logPrefix} - toJSON POLUÍDO INVOCADO! typeof this: ${typeof this}`, 'vuln', FNAME);
                    return { "hijack_successful_v23h": true, "call_count": callCount_toJSON_h }; // Retorno simples
                };
                ppAppliedSuccessfully_h = true;
                logS1("DEPURANDO: testPPJsonHijack_v23h - Poluição Object.prototype.toJSON APLICADA.", 'critical', FNAME);

                // --- PASSO 2: Testar JSON.stringify (manter comentado inicialmente) ---
                // /*
                logS1("DEPURANDO: testPPJsonHijack_v23h - ANTES de JSON.stringify (que está comentado/para ser descomentado)", 'warn', FNAME);
                // const result_h = JSON.stringify(testObject_h); 
                // logS1(`DEPURANDO: testPPJsonHijack_v23h - Resultado JSON.stringify: ${result_h ? result_h.substring(0,100) : "N/A"}`, 'info', FNAME);
                // */

            } catch (e) {
                logS1(`DEPURANDO: ERRO em testPPJsonHijack_v23h: ${e.message}`, 'error', FNAME);
                console.error("ERRO testPPJsonHijack_v23h:", e);
            } finally {
                logS1("DEPURANDO: testPPJsonHijack_v23h - Entrou no finally", 'critical', FNAME);
                if (ppAppliedSuccessfully_h) { 
                    if (originalToJSON_Descriptor_h) {
                        Object.defineProperty(Object.prototype, ppKey, originalToJSON_Descriptor_h);
                    } else {
                        delete Object.prototype[ppKey];
                    }
                    logS1(`Object.prototype.${ppKey} restaurado.`, 'good', 'Cleanup_v23h');
                }
            }
            logS1(`DEPURANDO: --- testPPJsonHijack_v23h Concluído ---`, 'test', FNAME);
        };

        const runIsolatedTest = async () => {
            const outputDiv = document.getElementById('output');
            if (outputDiv) outputDiv.innerHTML = '';
            console.log("runIsolatedTest (v2.3h) FOI CHAMADA! (console)");
            logS1("==== INICIANDO PoC Isolado v2.3h ====", 'test', 'runIsolatedTest');
            
            try {
                logS1("DEPURANDO: runIsolatedTest - Antes de chamar testPPJsonHijack_v23h", 'critical', 'runIsolatedTest');
                await testPPJsonHijack_v23h();
                logS1("DEPURANDO: runIsolatedTest - Depois de chamar testPPJsonHijack_v23h", 'critical', 'runIsolatedTest');
            } catch (e) {
                logS1(`DEPURANDO: ERRO em runIsolatedTest: ${e.message}`, 'error', 'runIsolatedTest');
                console.error("ERRO runIsolatedTest:", e);
            }
            
            await PAUSE_S1_FUNC(MEDIUM_PAUSE_S1);
            logS1("\n==== PoC Isolado v2.3h CONCLUÍDO ====", 'test', 'runIsolatedTest');
            if (runBtn) runBtn.disabled = false;
        };
    </script>
</body>
</html>
